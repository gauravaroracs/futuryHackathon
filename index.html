<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Green Impact Wallet ‚Äî Persona (Client-only, no-Auth, OpenAI optional)</title>
<style>
  :root{
    --bg:#0b0e11; --card:#131820; --ink:#f7fafc; --muted:#a8b3bf;
    --green:#22c55e; --green-ink:#062b16; --red:#ef4444; --focus:#93c5fd;
    --stroke:#243244; --glow:0 10px 40px rgba(34,197,94,.15);
  }
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif; background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased}
  .wrap{max-width:900px; margin:0 auto; padding:16px}
  header{display:flex; align-items:center; justify-content:space-between; margin:2px 0 14px}
  header h1{font-size:18px; margin:0; font-weight:800; letter-spacing:.2px}
  .brand{display:flex; gap:8px; align-items:center}
  .badge{background:var(--green); color:var(--green-ink); border-radius:999px; padding:4px 10px; font-weight:800; font-size:12px; box-shadow:var(--glow)}
  .pill{display:inline-flex; gap:8px; align-items:center; border:1px solid var(--stroke); border-radius:999px; padding:6px 10px; font-size:12px}
  .pill button{all:unset; cursor:pointer; font-weight:800; padding:4px 8px; border-radius:8px; border:1.5px solid var(--stroke)}
  .help{color:var(--muted); font-size:12px}

  .card{background:linear-gradient(180deg,#121926,#0f141b); border:1px solid var(--stroke); border-radius:16px; padding:14px; box-shadow:var(--glow)}
  fieldset{border:0; margin:0; padding:0}
  legend{font-size:12px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); margin:0 0 8px}
  .row{display:flex; flex-wrap:wrap; gap:12px}
  .chip{appearance:none; border:1.5px solid var(--stroke); background:transparent; color:var(--ink); padding:10px 12px; border-radius:999px; font-weight:700; font-size:14px; cursor:pointer; min-height:44px; min-width:44px; display:inline-flex; align-items:center; gap:8px}
  .chip[aria-checked="true"], .chip[aria-pressed="true"]{background:var(--green); color:var(--green-ink); border-color:var(--green)}
  .chip:focus-visible{outline:3px solid var(--focus); outline-offset:2px}
  input[type=email], select{flex:1; background:#0c1117; border:1.5px solid var(--stroke); color:var(--ink); padding:12px 14px; border-radius:12px; font-size:15px; min-height:48px}
  input[type=email]:focus, select:focus{outline:3px solid var(--focus); outline-offset:2px}
  label.switch{display:inline-flex; align-items:center; gap:8px; font-weight:700}
  .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .tools{position:sticky; bottom:8px; z-index:5; display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  .btn{background:#0c1117; border:1.5px solid var(--stroke); color:var(--ink); border-radius:12px; padding:12px 14px; font-weight:900; cursor:pointer; min-height:48px}
  .btn.primary{background:var(--green); color:var(--green-ink); border-color:var(--green)}
  .btn.small{padding:8px 10px; font-weight:800; font-size:13px; border-radius:10px}
  .error{color:var(--red); font-weight:800; font-size:12px; margin-top:6px}
  .error[hidden]{display:none}
  .status{font-size:12px; font-weight:800; margin-top:6px}
  .status.ok{color:var(--green)}
  .status.fail{color:var(--red)}
  .sr{position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}

  .loader{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); z-index:50}
  .loader.show{display:grid}
  .spinner{width:48px; height:48px; border-radius:999px; border:4px solid var(--stroke); border-top-color:var(--green); animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .grid{display:grid; gap:12px}
  .rec{background:linear-gradient(180deg,#121926,#0f141b); border:1px solid var(--stroke); border-radius:14px; padding:14px; display:grid; gap:8px}
  .rec h3{margin:0 0 6px; font-size:16px}
  .kpi {display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--stroke); font-size:12px}
  .kpi.co2 {background:linear-gradient(90deg,#1f8a4c33,#1f8a4c0f)}
  .kpi.eff {background:linear-gradient(90deg,#8a6a1f33,#8a6a1f0f)}
  .kpi.tok {background:linear-gradient(90deg,#22c55e44,#22c55e1a)}
  .bar {height:6px; background:#0e141b; border:1px solid var(--stroke); border-radius:999px; overflow:hidden}
  .bar > span {display:block; height:100%; background:linear-gradient(90deg,#22c55e,#86efac)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <span class="badge" aria-hidden="true">Green</span><h1>Persona</h1>
      </div>
      <div class="pill" id="aiPill">
        <span id="aiBadge">OpenAI: OFF</span>
        <button id="setKeyBtn" title="Set OpenAI API key">Set key</button>
        <button id="clearKeyBtn" title="Clear key">Clear</button>
      </div>
    </header>

    <!-- ===== Setup ===== -->
    <main id="setupView">
      <form id="form" class="grid" novalidate>
        <!-- Basics -->
        <section class="card">
          <fieldset role="group" aria-label="Basics">
            <legend>Basics</legend>
            <div class="inline">
              <label for="email" class="sr">Email</label>
              <input id="email" name="email" type="email" inputmode="email" autocomplete="email" placeholder="Email*" aria-describedby="err-email" required />
            </div>
            <div id="err-email" class="error" aria-live="polite" hidden></div>
          </fieldset>
        </section>

        <!-- Profile -->
        <section class="card">
          <fieldset role="group" aria-label="Profile">
            <legend>Profile</legend>
            <div class="inline" style="width:100%">
              <label class="sr" for="region">Region</label>
              <select id="region" aria-label="Region">
                <option value="" selected disabled>Region (e.g., BE, BY, HH)</option>
                <option>BE</option><option>BY</option><option>HH</option><option>NW</option><option>HE</option><option>BW</option><option>SN</option>
              </select>
              <label class="sr" for="ageBand">Age band</label>
              <select id="ageBand" aria-label="Age band">
                <option value="" selected disabled>Age band</option>
                <option>18-24</option><option>25-34</option><option>35-44</option><option>45-54</option><option>55+</option>
              </select>
            </div>
            <div class="inline" style="width:100%">
              <label class="sr" for="householdSize">Household size</label>
              <select id="householdSize" aria-label="Household size">
                <option value="" selected disabled>Household size</option>
                <option>1</option><option>2</option><option>3</option><option>4+</option>
              </select>
              <label class="sr" for="housingType">Housing type</label>
              <select id="housingType" aria-label="Housing type">
                <option value="" selected disabled>Housing type</option>
                <option>apartment</option><option>house</option><option>student</option><option>other</option>
              </select>
            </div>
          </fieldset>
        </section>

        <!-- Energy -->
        <section class="card">
          <fieldset role="group" aria-label="Energy">
            <legend>Energy</legend>
            <div>
              <div class="help" style="margin:0 0 6px">Heating</div>
              <div id="heating" class="row" role="radiogroup" aria-label="Heating" data-select="single">
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="gas">Gas</button>
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="district">District</button>
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="heat_pump">Heat Pump</button>
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="electric">Electric</button>
              </div>
            </div>
            <div style="margin-top:10px">
              <div class="help" style="margin:0 0 6px">Tariff</div>
              <div id="tariff" class="row" role="radiogroup" aria-label="Tariff" data-select="single">
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="fixed">Fixed</button>
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="dynamic">Dynamic</button>
              </div>
            </div>
            <div style="margin-top:10px">
              <label class="switch"><input id="smartMeter" type="checkbox" /> Smart meter</label>
            </div>
          </fieldset>
        </section>

        <!-- Devices -->
        <section class="card">
          <fieldset role="group" aria-label="Devices">
            <legend>Devices</legend>
            <div id="devices" class="row" role="group" aria-label="Devices" data-select="multi">
              <button type="button" class="chip" aria-pressed="false" data-value="ev">EV</button>
              <button type="button" class="chip" aria-pressed="false" data-value="pv">PV</button>
              <button type="button" class="chip" aria-pressed="false" data-value="heat_pump">HP</button>
              <button type="button" class="chip" aria-pressed="false" data-value="smart_plugs">Plugs</button>
              <button type="button" class="chip" aria-pressed="false" data-value="smart_thermostat">Thermo</button>
              <button type="button" class="chip" aria-pressed="false" data-value="smart_meter">Smart meter</button>
            </div>
          </fieldset>
        </section>

        <!-- Routine -->
        <section class="card">
          <fieldset role="group" aria-label="Routine">
            <legend>Routine</legend>
            <div>
              <div class="help" style="margin:0 0 6px">Home hours</div>
              <div id="homeHours" class="row" role="radiogroup" aria-label="Home hours" data-select="single">
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="Morning">Morning</button>
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="Afternoon">Afternoon</button>
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="Evening">Evening</button>
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="Night">Night</button>
                <button type="button" class="chip" role="radio" aria-checked="false" data-value="Mixed">Mixed</button>
              </div>
            </div>
          </fieldset>
        </section>

        <!-- Interests -->
        <section class="card">
          <fieldset role="group" aria-label="Interests">
            <legend>Interests</legend>
            <div id="interests" class="row" role="group" aria-label="Interests" data-select="multi">
              <button type="button" class="chip" aria-pressed="false" data-value="mobility">Mobility</button>
              <button type="button" class="chip" aria-pressed="false" data-value="home-efficiency">Home Efficiency</button>
              <button type="button" class="chip" aria-pressed="false" data-value="low-effort">Low Effort</button>
              <button type="button" class="chip" aria-pressed="false" data-value="cost-saving">Cost Saving</button>
              <button type="button" class="chip" aria-pressed="false" data-value="learning">Learning</button>
              <button type="button" class="chip" aria-pressed="false" data-value="sports-fitness">Sports & Fitness</button>
              <button type="button" class="chip" aria-pressed="false" data-value="technology">Technology</button>
              <button type="button" class="chip" aria-pressed="false" data-value="finance-investing">Finance & Investing</button>
              <button type="button" class="chip" aria-pressed="false" data-value="sustainability-environment">Sustainability & Environment</button>
              <button type="button" class="chip" aria-pressed="false" data-value="travel">Travel</button>
              <button type="button" class="chip" aria-pressed="false" data-value="food-cooking">Food & Cooking</button>
              <button type="button" class="chip" aria-pressed="false" data-value="science-research">Science & Research</button>
              <button type="button" class="chip" aria-pressed="false" data-value="fashion">Fashion</button>
              <button type="button" class="chip" aria-pressed="false" data-value="volunteering">Volunteering</button>
            </div>
          </fieldset>
        </section>

        <!-- Goals & Constraints -->
        <section class="card">
          <fieldset role="group" aria-label="Goals & Constraints">
            <legend>Goals & Constraints</legend>
            <div class="help" style="margin:0 0 6px">Goals</div>
            <div id="goals" class="row" role="group" aria-label="Goals" data-select="multi">
              <button type="button" class="chip" aria-pressed="false" data-value="save-money">Save Money</button>
              <button type="button" class="chip" aria-pressed="false" data-value="reduce-co2">Reduce CO‚ÇÇ</button>
              <button type="button" class="chip" aria-pressed="false" data-value="get-rewards">Get Rewards</button>
            </div>

            <div class="help" style="margin:10px 0 6px">Constraints</div>
            <div id="constraints" class="row" role="group" aria-label="Constraints" data-select="multi">
              <button type="button" class="chip" aria-pressed="false" data-value="landlord">Landlord</button>
              <button type="button" class="chip" aria-pressed="false" data-value="time-poor">Time-poor</button>
              <button type="button" class="chip" aria-pressed="false" data-value="low-budget">Low Budget</button>
            </div>
          </fieldset>
        </section>

        <!-- Consent -->
        <section class="card">
          <fieldset role="group" aria-label="Consent">
            <legend>Consent</legend>
            <div class="inline" style="gap:16px">
              <label><input type="checkbox" name="consent" value="photos"> Photos</label>
              <label><input type="checkbox" name="consent" value="receipts"> Receipts</label>
              <label><input type="checkbox" name="consent" value="appExports"> App Exports</label>
            </div>
          </fieldset>
        </section>

        <div id="saveStatus" class="status" aria-live="polite"></div>

        <div class="tools">
          <button type="submit" class="btn primary" id="submitBtn">Submit</button>
        </div>
      </form>
    </main>

    <!-- ===== Results ===== -->
    <main id="resultsView" hidden>
      <section class="card">
        <div class="inline" style="justify-content:space-between; align-items:center">
          <strong>Top 3 Challenges</strong>
          <div class="inline">
            <button id="backBtn" class="btn" type="button">Back</button>
          </div>
        </div>
        <div id="resultsEmail" class="help" style="margin-top:6px"></div>
      </section>
      <section class="grid" id="recsList" aria-live="polite"></section>
    </main>
  </div>

  <div id="loader" class="loader" aria-live="polite" aria-busy="true">
    <div class="spinner" aria-label="Matching‚Ä¶"></div>
  </div>

<script type="module">
  /* ---------------- Firebase (no Auth) ---------------- */
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    getDocs, query, where, doc, setDoc
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBuOoJV5nheBw3euykuMlvtehwFmnSHf_w",
    authDomain: "emission-impossible-6b979.firebaseapp.com",
    projectId: "emission-impossible-6b979",
    storageBucket: "emission-impossible-6b979.firebasestorage.app",
    messagingSenderId: "840522443479",
    appId: "1:840522443479:web:b2efc2bcf3ef45b6799e92",
    measurementId: "G-0GTRNT5ZY7"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // DEV guest id
  const guestId =
    localStorage.getItem('guest_id') ||
    (() => {
      const v = 'guest_' + (crypto.randomUUID?.() || Math.random().toString(36).slice(2));
      localStorage.setItem('guest_id', v);
      return v;
    })();

  /* -------- OpenAI (direct fetch, no SDK) -------- */
  let OPENAI_KEY = 'OPENAI_API_KEY_HERE';
  const aiBadge = document.getElementById('aiBadge');
  function refreshAiBadge(){
    const hasKey = (OPENAI_KEY && !OPENAI_KEY.includes('HERE')) || localStorage.getItem('OPENAI_API_KEY');
    aiBadge.textContent = hasKey ? 'OpenAI: ON' : 'OpenAI: OFF';
  }
  document.getElementById('setKeyBtn').addEventListener('click', ()=>{
    const k = prompt('Enter OpenAI API Key (stored in localStorage for this demo)');
    if(!k) return;
    localStorage.setItem('OPENAI_API_KEY', k.trim());
    OPENAI_KEY = k.trim();
    refreshAiBadge();
  });
  document.getElementById('clearKeyBtn').addEventListener('click', ()=>{
    localStorage.removeItem('OPENAI_API_KEY');
    refreshAiBadge();
  });
  if (localStorage.getItem('OPENAI_API_KEY')) OPENAI_KEY = localStorage.getItem('OPENAI_API_KEY');
  refreshAiBadge();

  /* Small helper: short one-liners if needed elsewhere */
  async function openaiOneLiner(prompt){
    const key = localStorage.getItem('OPENAI_API_KEY') || OPENAI_KEY;
    if(!key || key.includes('HERE')) return null;
    try{
      const resp = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: 'gpt-5-nano', input: prompt, max_output_tokens: 60 })
      });
      const data = await resp.json();
      return (data.output_text || '').trim();
    } catch(e){
      console.warn('OpenAI fetch failed', e);
      return null;
    }
  }

  /* ---------------- UI helpers ---------------- */
  const $  = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  function initChips(){
    $$('[data-select="single"]').forEach(group=>{
      group.addEventListener('click', e=>{
        const btn = e.target.closest('button.chip'); if(!btn) return;
        $$('.chip[role="radio"]', group).forEach(b=>b.setAttribute('aria-checked','false'));
        btn.setAttribute('aria-checked','true');
      });
    });
    $$('[data-select="multi"]').forEach(group=>{
      group.addEventListener('click', e=>{
        const btn = e.target.closest('button.chip'); if(!btn) return;
        btn.setAttribute('aria-pressed', String(btn.getAttribute('aria-pressed') !== 'true'));
      });
    });
  }
  function valSingle(id){ const g = $('#'+id); const sel = g?.querySelector('[aria-checked="true"]'); return sel ? sel.dataset.value : null; }
  function valMulti(id){ const g = $('#'+id); return g ? $$('.chip[aria-pressed="true"]', g).map(b=>b.dataset.value) : []; }
  function valSelect(id){ const el = $('#'+id); return el && el.value && !el.value.startsWith('Region') && !el.value.startsWith('Age') && !el.value.startsWith('Household') && !el.value.startsWith('Housing') ? el.value : null; }
  function getConsent(){ return Array.from(document.querySelectorAll('input[name="consent"]:checked')).map(i=>i.value); }
  function emailKey(email){ return encodeURIComponent((email||'').trim().toLowerCase()); }
  function showLoader(on){ $('#loader').classList.toggle('show', !!on); }
  function nav(to){ const a=$('#setupView'), b=$('#resultsView'); if(to==='results'){ a.hidden=true; b.hidden=false; location.hash='#results'; } else { a.hidden=false; b.hidden=true; location.hash='#setup'; } }
  function setStatus(message, type){ const el = $('#saveStatus'); el.textContent = message; el.className = 'status ' + (type||''); }

  /* ---------------- Persona save/fetch ---------------- */
  function serialize(){
    const email = $('#email').value.trim();
    const profile = {
      region: valSelect('region'),
      ageBand: valSelect('ageBand'),
      householdSize: valSelect('householdSize'),
      housingType: valSelect('housingType')
    };
    const energy = {
      heating: valSingle('heating'),
      tariff:  valSingle('tariff'),
      smartMeter: !!$('#smartMeter')?.checked
    };
    const routine = { homeHours: valSingle('homeHours') };
    return {
      email, profile, energy,
      devices: valMulti('devices'),
      routine,
      interests: valMulti('interests'),
      goals: valMulti('goals'),
      constraints: valMulti('constraints'),
      consent: getConsent(),
      timestamp: new Date().toISOString()
    };
  }
  function validate(){
    const email = $('#email');
    const emailErr = $('#err-email');
    let okFlag = true;
    if(!email.value.trim()){ emailErr.textContent='Email required'; emailErr.hidden=false; email.setAttribute('aria-invalid','true'); okFlag=false; }
    else if(!email.checkValidity()){ emailErr.textContent='Email invalid'; emailErr.hidden=false; email.setAttribute('aria-invalid','true'); okFlag=false; }
    else { emailErr.hidden=true; email.removeAttribute('aria-invalid'); }
    return okFlag;
  }
  async function savePersona(data){
    const ref = await addDoc(collection(db,'interests'), { ...data, createdAt: serverTimestamp() });
    return ref.id;
  }
  async function fetchLatestPersonaByEmail(email){
    const qRef = query(collection(db,'interests'), where('email','==', email));
    const snap = await getDocs(qRef);
    if (snap.empty) return null;
    const docs = snap.docs.map(d=>d.data());
    docs.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    return docs[0];
  }
  async function fetchActiveChallenges(){
    const snap = await getDocs(query(collection(db,'challenges'), where('active','==', true)));
    return snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }

  /* ---------------- Scoring (final formula per your rules) ---------------- */

  // Build prereq feature set from everything EXCEPT region; `requires` will match these.
  function toFeatureSet(p){
    const feats = new Set([
      ...(p?.devices || []),
      p?.energy?.heating,
      p?.energy?.smartMeter ? 'smart_meter' : null,
      p?.energy?.tariff ? `tariff:${p.energy.tariff}` : null,
      p?.routine?.homeHours ? `home:${p.routine.homeHours}` : null,
      ...(p?.constraints || []),
      p?.profile?.housingType ? `house:${p.profile.housingType}` : null,
      p?.profile?.householdSize ? `hh:${p.profile.householdSize}` : null,
    ].filter(Boolean));
    return feats;
  }

  // Exact location match (challenge.region or challenge.regions). Missing ‚Üí global (1).
  function locationMatch(persona, ch){
    const userRegion = persona?.profile?.region || null;
    const r1 = ch.region || null;
    const rMany = ch.regions || null;
    if (!r1 && !rMany) return 1; // global
    if (r1 && userRegion && r1 === userRegion) return 1;
    if (Array.isArray(rMany) && userRegion && rMany.includes(userRegion)) return 1;
    return 0;
  }

  // Tag alias to unify challenge tags with persona interests/goals
  const TAG_ALIAS = {
    'cost-saving':'save-money','low-effort':'low-effort','home-efficiency':'home-efficiency',
    'sports-fitness':'sports-fitness','sustainability-environment':'sustainability-environment',
    'finance-investing':'finance-investing','food-cooking':'food-cooking','science-research':'science-research',
    'technology':'technology','mobility':'mobility','learning':'learning','travel':'travel',
    'fashion':'fashion','volunteering':'volunteering','save-money':'save-money','reduce-co2':'reduce-co2','get-rewards':'get-rewards'
  };
  function normTag(t){ return TAG_ALIAS[t] || t; }

  // Effort mapping when categorical
  const EFFORT_MAP = { low:1, medium:2, high:3 };

  // Weights: interests 0.55 (most important), prereqs 0.25, CO‚ÇÇ 0.20, with capping + small effort penalty.
  function scoreByFormula(persona, ch, have, maxImpact){
    const loc = locationMatch(persona, ch);

    // Interest pool = persona.interests + persona.goals (as requested)
    const interestPool = new Set([...(persona?.interests || []), ...(persona?.goals || [])]);

    const tags = (ch.tags || []).map(normTag);
    const interestMatches = tags.filter(t => interestPool.has(t)).length;

    const requires = ch.requires || [];
    const prereqMatches = requires.filter(r => have.has(r)).length;

    const impact = Number(ch.impact ?? ch.impactKgCO2 ?? 0);
    const co2_norm = maxImpact > 0 ? Math.min(1, impact / maxImpact) : 0;

    let effortNumeric = Number.isFinite(ch.effort) ? Number(ch.effort)
                        : EFFORT_MAP[String(ch.effortLevel || '').toLowerCase()] || 2;

    const interestTerm = 0.55 * Math.min(1, interestMatches * 0.2);
    const prereqTerm   = 0.25 * Math.min(1, prereqMatches * 0.2);
    const co2Term      = 0.20 * co2_norm;
    const penalty      = 0.02 * effortNumeric;

    const inner      = Math.max(0, interestTerm + prereqTerm + co2Term - penalty);
    const finalScore = loc * inner;

    return {
      finalScore, loc, interestMatches, prereqMatches,
      co2_norm, impact, effortNumeric,
      interestTerm: Number(interestTerm.toFixed(3)),
      prereqTerm: Number(prereqTerm.toFixed(3)),
      co2Term: Number(co2Term.toFixed(3)),
      penalty: Number(penalty.toFixed(3)),
    };
  }

  function baseTokens(impact, goals=[]){
    let t = Math.max(1, Math.ceil((Number(impact)||0) * 0.5));
    if ((goals||[]).includes('get-rewards')) t += 1;
    return t;
  }

  function getContext(persona){
    const now = new Date(); const h = now.getHours(); const m = now.getMonth()+1;
    const home = persona?.routine?.homeHours;
    const nightPref = home === 'Night';
    const eveningPref = home === 'Evening';
    const mixedPref = home === 'Mixed';
    return {
      night: nightPref || eveningPref || mixedPref || (h>=22||h<6),
      midday: mixedPref || (h>=11 && h<=15),
      cold: (m<=3 || m>=11),
      tariff: persona?.energy?.tariff || null,
      smart: !!persona?.energy?.smartMeter
    };
  }

  /* ---------- Rich "About" + user-specific "Why you" ---------- */

  const EFFORT_TEXT = { 1: 'low', 2: 'medium', 3: 'high' };

  function formatAbout(ch){
    const impact = Number(ch.impact ?? ch.impactKgCO2 ?? 0);
    const effortNum = Number.isFinite(ch.effort) ? ch.effort
                    : ({low:1, medium:2, high:3}[String(ch.effortLevel||'').toLowerCase()] || 2);
    const effort = EFFORT_TEXT[effortNum] || 'medium';
    const ev = (ch.evidence || []).join(', ') || '‚Äî';
    const base = ch.explain || ch.explanation || ch.title || 'This challenge reduces energy use and emissions.';
    return `${base} Impact ‚âà ${Math.round(impact)} kg CO‚ÇÇ. Effort: ${effort}. Evidence: ${ev}.`;
  }

  const LABELS = {
    'mobility':'Mobility','home-efficiency':'Home Efficiency','low-effort':'Low Effort',
    'cost-saving':'Cost Saving','learning':'Learning','sports-fitness':'Sports & Fitness',
    'technology':'Technology','finance-investing':'Finance & Investing',
    'sustainability-environment':'Sustainability & Environment','travel':'Travel',
    'food-cooking':'Food & Cooking','science-research':'Science & Research',
    'fashion':'Fashion','volunteering':'Volunteering',
    'save-money':'Save Money','reduce-co2':'Reduce CO‚ÇÇ','get-rewards':'Get Rewards'
  };

  function buildWhyPersonal(persona, ch, have, ctx, s){
    const region = persona?.profile?.region;
    const interestPool = new Set([...(persona?.interests||[]), ...(persona?.goals||[])]);
    const tags = (ch.tags||[]);
    const requires = (ch.requires||[]);
    const matchedInterests = tags.filter(t => interestPool.has(t)).map(t => LABELS[t] || t);
    const matchedPrereqs   = requires.filter(r => have.has(r));

    const bits = [];

    if (matchedInterests.length){
      const top = matchedInterests.slice(0,3).join(', ');
      bits.push(`You selected ${top}, which aligns directly with this challenge.`);
    } else if ((persona?.goals||[]).length){
      bits.push(`This supports your goals (${(persona.goals||[]).map(g=>LABELS[g]||g).slice(0,2).join(', ')}).`);
    }

    if (matchedPrereqs.length){
      bits.push(`Your setup (${matchedPrereqs.join(', ')}) means you can do this with minimal friction.`);
    }
    if (ctx.tariff==='dynamic' && (tags.includes('electricity') || ch.category==='electricity')){
      bits.push(`With a dynamic tariff, shifting use to cheaper hours lowers both costs and CO‚ÇÇ.`);
    }
    if ((ch.requires||[]).includes('ev') && (ctx.night || persona?.routine?.homeHours==='Night')){
      bits.push(`Your night routine makes scheduled charging a natural fit.`);
    }
    if ((ch.requires||[]).includes('pv') && ctx.midday){
      bits.push(`Your midday availability lets you lean on PV generation.`);
    }

    if ((ch.region || (Array.isArray(ch.regions) && ch.regions.length)) && region){
      bits.push(`Available in your region (${region}).`);
    }
    if ((persona?.constraints||[]).includes('landlord') && requires.some(r=>['pv','heat_pump'].includes(r))){
      bits.push(`Heads-up: this may require landlord approval.`);
    }

    const effortNum = Number.isFinite(ch.effort) ? ch.effort
                    : ({low:1, medium:2, high:3}[String(ch.effortLevel||'').toLowerCase()] || 2);
    const effort = EFFORT_TEXT[effortNum] || 'medium';
    const impact = Number(ch.impact ?? ch.impactKgCO2 ?? 0);
    bits.push(`Estimated impact ‚âà ${Math.round(impact)} kg CO‚ÇÇ with ${effort} effort.`);

    return bits.join(' ');
  }

  async function llmPersonalWhy(persona, ch, s){
    const key = localStorage.getItem('OPENAI_API_KEY') || (typeof OPENAI_KEY!=='undefined' ? OPENAI_KEY : '');
    if(!key || String(key).includes('HERE')) return null;
    const prompt = `User profile: ${[
      persona?.profile?.region ? `region=${persona.profile.region}` : '',
      `interests=${(persona?.interests||[]).join('|')}`,
      `goals=${(persona?.goals||[]).join('|')}`,
      (persona?.devices||[]).length ? `devices=${persona.devices.join('|')}` : '',
      persona?.energy?.tariff ? `tariff=${persona.energy.tariff}` : '',
      persona?.routine?.homeHours ? `homeHours=${persona.routine.homeHours}` : '',
      (persona?.constraints||[]).length ? `constraints=${persona.constraints.join('|')}` : ''
    ].filter(Boolean).join('; ')}
Challenge: ${ch.title}. Tags=${(ch.tags||[]).join(', ')}. Requires=${(ch.requires||[]).join(', ')||'none'}. Impact‚âà${Math.round(Number(ch.impact ?? ch.impactKgCO2 ?? 0))} kg CO2. Effort=${String(ch.effortLevel||EFFORT_TEXT[ch.effort||2]||'medium')}.
Write a single friendly paragraph (40‚Äì60 words) explaining why this challenge uniquely fits this user. Reference one or two of their interests/goals and any matching devices or routine. Mention impact and effort. No emojis.`;
    try{
      const resp = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: 'gpt-5-nano', input: prompt, max_output_tokens: 140 })
      });
      const data = await resp.json();
      return (data.output_text || '').trim() || null;
    }catch(e){ console.warn('LLM why failed', e); return null; }
  }

  /* ---------------- Rank + write recs (console.table) ---------------- */
  async function rankAndWriteRecommendations(email){
    const persona = await fetchLatestPersonaByEmail(email);
    if (!persona) throw new Error('No persona for this email');

    const challenges = await fetchActiveChallenges();
    const have = toFeatureSet(persona);
    const ctx  = getContext(persona);

    const maxImpact = Math.max(...challenges.map(ch => Number(ch.impact ?? ch.impactKgCO2 ?? 0)), 0);

    const rowsForConsole = [];
    const scored = await Promise.all(challenges.map(async ch=>{
      const s = scoreByFormula(persona, ch, have, maxImpact);
      rowsForConsole.push({
        challengeId: ch.id,
        title: ch.title || ch.id,
        region: ch.region || (Array.isArray(ch.regions) ? ch.regions.join('|') : '‚Äî'),
        location: s.loc,
        interestMatches: s.interestMatches,
        prereqMatches: s.prereqMatches,
        co2_norm: Number(s.co2_norm.toFixed(3)),
        impactKgCO2: s.impact,
        interestTerm: s.interestTerm,
        prereqTerm: s.prereqTerm,
        co2Term: s.co2Term,
        penalty: s.penalty,
        finalScore: Number(s.finalScore.toFixed(4))
      });

      if (s.finalScore <= 0) return null;

      const impact = Number(ch.impact ?? ch.impactKgCO2 ?? 0);
      const effort = Number.isFinite(ch.effort) ? Number(ch.effort)
                    : ( {low:1, medium:2, high:3}[String(ch.effortLevel||'').toLowerCase()] || 2 );

      // Richer copy
      const about_rich = formatAbout(ch);
      const why_personal_fallback = buildWhyPersonal(persona, ch, have, ctx, s);
      const why_personal_llm = await llmPersonalWhy(persona, ch, s);
      const why_final = (why_personal_llm && why_personal_llm.length > 20) ? why_personal_llm : why_personal_fallback;

      return {
        challengeId: ch.id,
        title: ch.title || ch.id,
        impact,
        effort,
        score: s.finalScore,                // <-- your score used for ranking
        about_rich,
        why_personal: why_final,
        explain: ch.explain || ch.explanation || null,
        tokens: baseTokens(impact, persona?.goals),
        _raw: ch
      };
    })).then(arr => arr.filter(Boolean));

    console.group(`Challenge scores for ${email} (region=${persona?.profile?.region || 'n/a'})`);
    console.table(rowsForConsole.sort((a,b)=> b.finalScore - a.finalScore));
    console.groupEnd();

    scored.sort((a,b)=> b.score - a.score);
    const top3 = scored.slice(0,3);

    // Persist top 3 (optional)
    const bucketRef = doc(db,'recommendations', emailKey(email));
    for (const it of top3){
      const payload = {
        challengeId: it.challengeId, title: it.title,
        impact: it.impact, effort: it.effort, score: it.score,
        tokens: it.tokens, why: it.why_personal, about: it.about_rich,
        createdAt: serverTimestamp()
      };
      await setDoc(doc(bucketRef,'items', it.challengeId), payload, { merge:true });
    }
    return top3;
  }

  /* ---------------- Record Start/Later (no Auth) ---------------- */
  async function recordAction({ email, challengeId, action, tokens = 0, impact = 0 }) {
    return await addDoc(collection(db, 'actions'), {
      email: email || null,
      challengeId,
      action, tokens, impact,
      guestId,
      createdAt: serverTimestamp()
    });
  }

  /* ---------------- Render ---------------- */
  function renderResults(email, items){
    $('#resultsEmail').textContent = `for: ${email}`;
    const list = $('#recsList'); list.innerHTML = '';
    if (!items.length){
      const empty = document.createElement('div');
      empty.className='card'; empty.textContent = 'No matches yet.';
      list.appendChild(empty); return;
    }
    const maxImpact = Math.max(...items.map(i => Number(i.impact)||0), 1);

    items.forEach(it=>{
      const d = document.createElement('div');
      d.className = 'rec';
      const pct = Math.max(5, Math.round((Number(it.impact)||0) / maxImpact * 100));
      d.innerHTML = `
        <h3>${it.title}</h3>
        <div class="inline" style="gap:8px; flex-wrap:wrap">
          <span class="kpi co2"><i>üå± CO‚ÇÇ‚Üì</i> ${Math.round(it.impact)} kg</span>
          <span class="kpi eff"><i>‚öôÔ∏è Effort</i> ${it.effort}</span>
          <span class="kpi tok"><i>üéüÔ∏è Tokens</i> ${it.tokens}</span>
        </div>
        <div class="bar" aria-hidden="true" style="margin:6px 0 2px"><span style="width:${pct}%"></span></div>
        <small class="help">About: ${it.about_rich}</small><br/>
        <small class="help">Why you: ${it.why_personal}</small>
        <div class="inline" style="gap:8px; margin-top:8px">
          <button class="btn small primary" data-accept="${it.challengeId}">Start</button>
          <button class="btn small" data-later="${it.challengeId}">Later</button>
        </div>
      `;
      list.appendChild(d);
    });

    list.addEventListener('click', async (e)=>{
      const startBtn = e.target.closest('button[data-accept]');
      const laterBtn = e.target.closest('button[data-later]');
      const target   = startBtn || laterBtn;
      if (!target) return;

      const id   = target.getAttribute(startBtn ? 'data-accept' : 'data-later');
      const pick = items.find(x => x.challengeId === id);
      if (!pick) return;

      try {
        await recordAction({
          email,
          challengeId: id,
          action: startBtn ? 'accept' : 'later',
          tokens: startBtn ? (pick.tokens || 0) : 0,
          impact: pick.impact || 0
        });
        target.textContent = startBtn ? 'Added ‚úì' : 'Snoozed ‚úì';
        target.disabled = true;
      } catch (err) {
        console.error(err);
        alert('Could not record your action. Please check Firestore rules/connection (dev mode requires open rules).');
      }
    });
  }

  /* ---------------- Wire UI ---------------- */
  function init(){
    initChips();
    $('#backBtn').addEventListener('click', ()=> nav('setup'));
    $('#form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!validate()) return;
      const data = serialize();
      const email = data.email;

      showLoader(true);
      setStatus('Saving‚Ä¶','');

      try{
        await savePersona(data);
        setStatus('Saved ‚úì','ok');
        const items = await rankAndWriteRecommendations(email);
        renderResults(email, items);
        nav('results');
      } catch(err){
        console.warn(err);
        setStatus('Error: '+(err.message||err),'fail');
      } finally {
        showLoader(false);
      }
    });
    window.addEventListener('hashchange', ()=>{
      if(location.hash === '#results') nav('results'); else nav('setup');
    });
  }
  init();
</script>
</body>
</html>