<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Green Impact Wallet ‚Äî Persona (Client-only)</title>
<style>
  :root{
    --bg:#0b0e11; --card:#131820; --ink:#f7fafc; --muted:#a8b3bf;
    --green:#22c55e; --green-ink:#062b16; --red:#ef4444; --focus:#93c5fd;
    --stroke:#243244;
    --glow:0 10px 40px rgba(34,197,94,.15);
  }
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif; background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased}
  .wrap{max-width:900px; margin:0 auto; padding:16px}
  header{display:flex; align-items:center; justify-content:space-between; margin:2px 0 14px}
  header h1{font-size:18px; margin:0; font-weight:800; letter-spacing:.2px}
  .brand{display:flex; gap:8px; align-items:center}
  .badge{background:var(--green); color:var(--green-ink); border-radius:999px; padding:4px 10px; font-weight:800; font-size:12px; box-shadow:var(--glow)}
  .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:14px}
  .card.soft{background:linear-gradient(180deg,#121926,#0e141b); box-shadow:var(--glow)}
  fieldset{border:0; margin:0; padding:0}
  legend{font-size:12px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); margin:0 0 8px}
  .row{display:flex; flex-wrap:wrap; gap:12px}
  .chip{appearance:none; border:1.5px solid var(--stroke); background:transparent; color:var(--ink); padding:10px 12px; border-radius:999px; font-weight:700; font-size:14px; cursor:pointer; min-height:44px; min-width:44px; display:inline-flex; align-items:center; gap:8px}
  .chip[aria-checked="true"], .chip[aria-pressed="true"]{background:var(--green); color:var(--green-ink); border-color:var(--green)}
  .chip:focus-visible{outline:3px solid var(--focus); outline-offset:2px}
  input[type=email]{flex:1; background:#0c1117; border:1.5px solid var(--stroke); color:var(--ink); padding:12px 14px; border-radius:12px; font-size:15px; min-height:48px}
  input[type=email]:focus{outline:3px solid var(--focus); outline-offset:2px}
  .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .tools{position:sticky; bottom:8px; z-index:5; display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  .btn{background:#0c1117; border:1.5px solid var(--stroke); color:var(--ink); border-radius:12px; padding:12px 14px; font-weight:900; cursor:pointer; min-height:48px; transition:transform .06s ease}
  .btn.primary{background:var(--green); color:var(--green-ink); border-color:var(--green)}
  .btn.small{padding:8px 10px; font-weight:800; font-size:13px; border-radius:10px}
  .btn:active{transform:scale(.98)}
  .btn:focus-visible{outline:3px solid var(--focus); outline-offset:2px}
  .error{color:var(--red); font-weight:800; font-size:12px; margin-top:6px}
  .error[hidden]{display:none}
  .help{color:var(--muted); font-size:12px}
  .status{font-size:12px; font-weight:800; margin-top:6px}
  .status.ok{color:var(--green)}
  .status.fail{color:var(--red)}
  .sr{position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}

  /* Loader overlay */
  .loader{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); z-index:50}
  .loader.show{display:grid}
  .spinner{width:48px; height:48px; border-radius:999px; border:4px solid var(--stroke); border-top-color:var(--green); animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Results */
  .grid{display:grid; gap:12px}
  .rec{background:linear-gradient(180deg,#121926,#0f141b); border:1px solid var(--stroke); border-radius:14px; padding:14px; display:grid; gap:8px; box-shadow:var(--glow)}
  .rec h3{margin:0 0 6px; font-size:16px}
  .kpi {display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--stroke); font-size:12px}
  .kpi.co2 {background:linear-gradient(90deg,#1f8a4c33,#1f8a4c0f)}
  .kpi.eff {background:linear-gradient(90deg,#8a6a1f33,#8a6a1f0f)}
  .kpi.tok {background:linear-gradient(90deg,#22c55e44,#22c55e1a)}
  .kpi i {font-style:normal; opacity:.85}
  .bar {height:6px; background:#0e141b; border:1px solid var(--stroke); border-radius:999px; overflow:hidden}
  .bar > span {display:block; height:100%; background:linear-gradient(90deg,#22c55e,#86efac)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><span class="badge" aria-hidden="true">Green</span><h1>Persona</h1></div>
      <small class="help">‚â§ 60s</small>
    </header>

    <!-- ====== View: Setup (5 key fields) ====== -->
    <main id="setupView">
      <form id="form" class="grid" novalidate>
        <section class="card soft">
          <fieldset role="group" aria-label="Basics">
            <legend>Basics</legend>
            <div class="inline">
              <label for="email" class="sr">Email</label>
              <input id="email" name="email" type="email" inputmode="email" autocomplete="email" placeholder="Email*" aria-describedby="err-email" required />
            </div>
            <div id="err-email" class="error" aria-live="polite" hidden></div>
          </fieldset>
        </section>

        <section class="card">
          <fieldset role="group" aria-label="Energy">
            <legend>Heating</legend>
            <div id="heating" class="row" role="radiogroup" aria-label="Heating" data-select="single">
              <button type="button" class="chip" role="radio" aria-checked="false" data-value="gas">Gas</button>
              <button type="button" class="chip" role="radio" aria-checked="false" data-value="district">District</button>
              <button type="button" class="chip" role="radio" aria-checked="false" data-value="heat_pump">Heat Pump</button>
              <button type="button" class="chip" role="radio" aria-checked="false" data-value="electric">Electric</button>
            </div>
          </fieldset>
        </section>

        <section class="card">
          <fieldset role="group" aria-label="Devices">
            <legend>Devices</legend>
            <div id="devices" class="row" role="group" aria-label="Devices" data-select="multi">
              <button type="button" class="chip" aria-pressed="false" data-value="ev">EV</button>
              <button type="button" class="chip" aria-pressed="false" data-value="pv">PV</button>
              <button type="button" class="chip" aria-pressed="false" data-value="heat_pump">HP</button>
              <button type="button" class="chip" aria-pressed="false" data-value="smart_plugs">Plugs</button>
              <button type="button" class="chip" aria-pressed="false" data-value="smart_thermostat">Thermo</button>
            </div>
          </fieldset>
        </section>

        <section class="card">
          <fieldset role="group" aria-label="Interests">
            <legend>Interests</legend>
            <div id="interests" class="row" role="group" aria-label="Interests" data-select="multi">
              <button type="button" class="chip" aria-pressed="false" data-value="mobility">Mobility</button>
              <button type="button" class="chip" aria-pressed="false" data-value="home-efficiency">Home Efficiency</button>
              <button type="button" class="chip" aria-pressed="false" data-value="low-effort">Low Effort</button>
              <button type="button" class="chip" aria-pressed="false" data-value="cost-saving">Cost Saving</button>
              <button type="button" class="chip" aria-pressed="false" data-value="learning">Learning</button>
            </div>
          </fieldset>
        </section>

        <section class="card">
          <fieldset role="group" aria-label="Preferences">
            <legend>Weighting</legend>
            <div id="weighting" class="row" role="radiogroup" aria-label="Weighting" data-select="single">
              <button type="button" class="chip" role="radio" aria-checked="false" data-value="balanced">Balanced</button>
              <button type="button" class="chip" role="radio" aria-checked="false" data-value="low-effort">Low Effort</button>
              <button type="button" class="chip" role="radio" aria-checked="false" data-value="high-impact">High Impact</button>
              <button type="button" class="chip" role="radio" aria-checked="false" data-value="cost-saving">Cost Saving</button>
            </div>
          </fieldset>
          <div id="saveStatus" class="status" aria-live="polite"></div>
        </section>

        <div class="tools">
          <button type="submit" class="btn primary" id="submitBtn">Submit</button>
        </div>
      </form>
    </main>

    <!-- ====== View: Results ====== -->
    <main id="resultsView" hidden>
      <section class="card">
        <div class="inline" style="justify-content:space-between; align-items:center">
          <strong>Top 3 Challenges</strong>
          <div class="inline">
            <button id="backBtn" class="btn" type="button">Back</button>
          </div>
        </div>
        <div id="resultsEmail" class="help" style="margin-top:6px"></div>
      </section>

      <section class="grid" id="recsList" aria-live="polite" style="padding: 10px;"></section>
    </main>
  </div>

  <!-- Loader -->
  <div id="loader" class="loader" aria-live="polite" aria-busy="true">
    <div class="spinner" aria-label="Matching‚Ä¶"></div>
  </div>

<!-- Firebase + App code -->
<script type="module">
  // Firebase SDK
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    getDocs, query, where, doc, setDoc
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // --- CONFIG (yours) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBuOoJV5nheBw3euykuMlvtehwFmnSHf_w",
    authDomain: "emission-impossible-6b979.firebaseapp.com",
    projectId: "emission-impossible-6b979",
    storageBucket: "emission-impossible-6b979.firebasestorage.app",
    messagingSenderId: "840522443479",
    appId: "1:840522443479:web:b2efc2bcf3ef45b6799e92",
    measurementId: "G-0GTRNT5ZY7"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ===== UI helpers =====
  const $  = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  function initChips(){
    $$('[data-select="single"]').forEach(group=>{
      group.addEventListener('click', e=>{
        const btn = e.target.closest('button.chip'); if(!btn) return;
        $$('.chip[role="radio"]', group).forEach(b=>b.setAttribute('aria-checked','false'));
        btn.setAttribute('aria-checked','true');
      });
    });
    $$('[data-select="multi"]').forEach(group=>{
      group.addEventListener('click', e=>{
        const btn = e.target.closest('button.chip'); if(!btn) return;
        btn.setAttribute('aria-pressed', String(btn.getAttribute('aria-pressed') !== 'true'));
      });
    });
  }
  function valSingle(id){ const g = $('#'+id); const sel = g?.querySelector('[aria-checked="true"]'); return sel ? sel.dataset.value : null; }
  function valMulti(id){ const g = $('#'+id); return g ? $$('.chip[aria-pressed="true"]', g).map(b=>b.dataset.value) : []; }
  function emailKey(email){ return encodeURIComponent((email||'').trim().toLowerCase()); }
  function showLoader(on){ $('#loader').classList.toggle('show', !!on); }
  function nav(to){ const a=$('#setupView'), b=$('#resultsView'); if(to==='results'){ a.hidden=true; b.hidden=false; location.hash='#results'; } else { a.hidden=false; b.hidden=true; location.hash='#setup'; } }
  function setStatus(msg, type){ const el = $('#saveStatus'); el.textContent = msg; el.className = 'status ' + (type||''); }

  // ===== Persona serialize/validate/save =====
  function serialize(){
    const email = $('#email').value.trim();
    return {
      email,
      energy: { heating: valSingle('heating') },
      devices: valMulti('devices'),
      interests: valMulti('interests'),
      weighting: valSingle('weighting'),
      timestamp: new Date().toISOString()
    };
  }
  function validate(){
    const email = $('#email');
    const emailErr = $('#err-email');
    let ok = true;
    if(!email.value.trim()){ emailErr.textContent='Email required'; emailErr.hidden=false; email.setAttribute('aria-invalid','true'); ok=false; }
    else if(!email.checkValidity()){ emailErr.textContent='Email invalid'; emailErr.hidden=false; email.setAttribute('aria-invalid','true'); ok=false; }
    else { emailErr.hidden=true; email.removeAttribute('aria-invalid'); }
    return ok;
  }
  async function savePersona(data){
    const ref = await addDoc(collection(db,'interests'), { ...data, createdAt: serverTimestamp() });
    return ref.id;
  }
  async function fetchLatestPersonaByEmail(email){
    const qRef = query(collection(db,'interests'), where('email','==', email));
    const snap = await getDocs(qRef);
    if (snap.empty) return null;
    const docs = snap.docs.map(d=>d.data());
    docs.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    return docs[0];
  }
  async function fetchActiveChallenges(){
    const snap = await getDocs(query(collection(db,'challenges'), where('active','==', true)));
    return snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }

  // ===== Context & scoring (client-only ‚ÄúAI-lite‚Äù) =====
  function getContext(){
    const now = new Date();
    const h = now.getHours();
    const m = now.getMonth()+1;
    const night = (h>=22 || h<6);
    const midday = (h>=11 && h<=15);
    const cold = (m<=3 || m>=11); // Nov‚ÄìMar
    return { hour:h, night, midday, cold };
  }
  function toFeatureSet(p){
    return new Set([ ...(p?.devices||[]), p?.energy?.heating, ...(p?.interests||[]), p?.weighting ].filter(Boolean));
  }
  function baseTokens(impact, weighting){
    const mult = weighting==='high-impact' ? 0.6 : weighting==='low-effort' ? 0.45 : 0.5;
    return Math.max(1, Math.ceil((Number(impact)||0) * mult));
  }
  function buildWhy(persona, ch, have, ctx){
    const req  = ch.requires || [];
    const tags = ch.tags || [];
    const bits = [];
    if (req.includes('ev') && have.has('ev')) {
      bits.push(ctx.night ? 'You have an EV and it‚Äôs night ‚Äî cleanest charging now.' : 'You have an EV ‚Äî schedule night charging.');
    }
    if (req.includes('pv') && have.has('pv')) {
      bits.push(ctx.midday ? 'You have PV and it‚Äôs midday ‚Äî shift loads to sunshine.' : 'You have PV ‚Äî shift loads to sunny hours.');
    }
    if (ch.category==='heating' && ctx.cold) bits.push('Cold season ‚Üí heating cuts save most CO‚ÇÇ.');
    if (tags.includes('cost-saving') && (persona?.weighting==='cost-saving')) bits.push('Aligned with your cost-saving focus.');
    if (tags.includes('home-efficiency') && (persona?.interests||[]).includes('home-efficiency')) bits.push('Fits your Home Efficiency interest.');
    if (!bits.length) bits.push('Good fit for your setup and goals.');
    return bits.join(' ‚Ä¢ ');
  }
  function buildNudge(ch, ctx){
    if (ch.id?.includes('ev') && ctx.night) return 'Plug in before bed tonight.';
    if (ch.id?.includes('pv') && ctx.midday) return 'Run a load at lunchtime today.';
    if (ch.category==='heating') return 'Try it for a week and track comfort.';
    if ((ch.tags||[]).includes('low-effort')) return 'Quick win‚Äîstart now.';
    return 'Set a reminder and take the first step.';
  }
  function scoreChallenge(ch, have, persona, ctx){
    const requires = ch.requires || [];
    if (requires.some(r => !have.has(r))) return null;

    const impact = Number(ch.impact ?? ch.impactKgCO2 ?? 0);
    const effort = Number(ch.effort ?? 1);
    const tags   = ch.tags || [];

    // relevance: requires/tags overlap
    let rel = 0;
    requires.forEach(r => { if (have.has(r)) rel += 2; });   // requires matched are strong signals
    tags.forEach(t => { if (have.has(t)) rel += 1; });

    // preference shaping
    if (persona?.weighting==='low-effort') rel += (effort<=2 ? 2 : -1);
    if (persona?.weighting==='high-impact') rel += (impact>=15 ? 2 : 0);
    if (persona?.weighting==='cost-saving' && tags.includes('cost-saving')) rel += 2;

    // contextual boosters
    if (requires.includes('ev') && ctx.night) rel += 2;
    if (requires.includes('pv') && ctx.midday) rel += 2;
    if (ch.category==='heating' && ctx.cold) rel += 2;

    const score = rel * (impact||1) - 0.7 * effort;

    // client-side ‚Äúwhy‚Äù & tokens & nudge
    const why   = buildWhy(persona, ch, have, ctx);
    const nudge = buildNudge(ch, ctx);
    const tokens= baseTokens(impact, persona?.weighting);

    return {
      challengeId: ch.id,
      title: ch.title || ch.id,
      impact, effort, score,
      explain: ch.explain ?? ch.explanation ?? null,
      why, nudge, tokens
    };
  }

  async function rankAndWriteRecommendations(email){
    const persona = await fetchLatestPersonaByEmail(email);
    if (!persona) throw new Error('No persona for this email');
    const have        = toFeatureSet(persona);
    const ctx         = getContext();
    const challenges  = await fetchActiveChallenges();

    // if user picked almost nothing ‚Üí cold-start: sort by (impact - effort)
    const minimal = (!persona.devices?.length && !persona.interests?.length && !persona.energy?.heating && !persona.weighting);

    const ranked = challenges
      .map(c => minimal
            ? ({
                challengeId:c.id,
                title:c.title || c.id,
                impact:Number(c.impact ?? c.impactKgCO2 ?? 0),
                effort:Number(c.effort ?? 1),
                score:(Number(c.impact ?? c.impactKgCO2 ?? 0)) - 0.7*(Number(c.effort ?? 1)),
                explain:c.explain ?? c.explanation ?? null,
                why:'Solid starter with good impact per effort.',
                nudge: buildNudge(c, ctx),
                tokens: baseTokens(Number(c.impact ?? c.impactKgCO2 ?? 0), 'balanced')
              })
            : scoreChallenge(c, have, persona, ctx))
      .filter(Boolean)
      .sort((a,b)=> b.score - a.score)
      .slice(0,3);

    const bucketRef = doc(db,'recommendations', emailKey(email));
    for (const it of ranked){
      await setDoc(doc(bucketRef,'items', it.challengeId), { ...it, createdAt: serverTimestamp() }, { merge:true });
    }
    return ranked;
  }

  // ===== Render Results =====
  function renderResults(email, items){
    $('#resultsEmail').textContent = `for: ${email}`;
    const list = $('#recsList'); list.innerHTML = '';
    if (!items.length){
      const empty = document.createElement('div');
      empty.className='card'; empty.textContent = 'No matches yet.';
      list.appendChild(empty);
      return;
    }
    const maxImpact = Math.max(...items.map(i => Number(i.impact)||0), 1);

    items.forEach(it=>{
      const d = document.createElement('div');
      d.className = 'rec';
      const pct = Math.max(5, Math.round((Number(it.impact)||0) / maxImpact * 100));
      d.innerHTML = `
        <h3>${it.title}</h3>
        <div class="inline" style="gap:8px; flex-wrap:wrap">
          <span class="kpi co2"><i>üå± CO‚ÇÇ‚Üì</i> ${Math.round(it.impact)} kg</span>
          <span class="kpi eff"><i>‚öôÔ∏è Effort</i> ${it.effort}</span>
          <span class="kpi tok"><i>üéüÔ∏è Tokens</i> ${it.tokens}</span>
        </div>
        <div class="bar" aria-hidden="true" style="margin:6px 0 2px"><span style="width:${pct}%"></span></div>
        <small class="help">About: ${it.explain || '‚Äî'}</small><br/>
        <small class="help">Why you: ${it.why || '‚Äî'}</small>
        <div class="help" style="margin-top:6px">üí° ${it.nudge}</div>
        <div class="inline" style="gap:8px; margin-top:8px">
          <button class="btn small primary" data-accept="${it.challengeId}">Start</button>
          <button class="btn small" data-later="${it.challengeId}">Later</button>
        </div>
      `;
      list.appendChild(d);
    });

    // accept handler (writes to Firestore)
    list.addEventListener('click', async (e)=>{
      const startBtn = e.target.closest('button[data-accept]');
      if (!startBtn) return;
      const id = startBtn.getAttribute('data-accept');
      const pick = items.find(x => x.challengeId === id);
      if (!pick) return;
      await addDoc(collection(db,'acceptances'), {
        email, challengeId: id, tokens: pick.tokens || 0, impact: pick.impact,
        status: 'accepted', createdAt: serverTimestamp()
      });
      startBtn.textContent = 'Added ‚úì';
      startBtn.disabled = true;
    }, { once:true });
  }

  // ===== Wire UI =====
  initChips();
  $('#backBtn').addEventListener('click', ()=> nav('setup'));

  $('#form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!validate()) return;
    const data = serialize();
    const email = data.email;

    showLoader(true);
    setStatus('Saving‚Ä¶','');

    try{
      await savePersona(data);
      setStatus('Saved ‚úì','ok');
      const items = await rankAndWriteRecommendations(email);
      renderResults(email, items);
      nav('results');
    } catch(err){
      console.warn(err);
      setStatus('Error: '+(err.message||err),'fail');
    } finally {
      showLoader(false);
    }
  });

  window.addEventListener('hashchange', ()=>{
    if(location.hash === '#results') nav('results'); else nav('setup');
  });
</script>
</body>
</html>